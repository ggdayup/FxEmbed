name: Redeploy / Rollback

on:
  workflow_dispatch:
    inputs:
      git_ref:
        description: 'Git ref to deploy (commit SHA / tag / branch). Example: c2091e3'
        required: true
        default: 'main'

jobs:
  redeploy:
    runs-on: ubuntu-latest
    env:
      STANDARD_DOMAIN_LIST: "workers.dev,fixtweet.ggdayup.workers.dev"
      STANDARD_BSKY_DOMAIN_LIST: "bsky.ggdayup.workers.dev"
      STANDARD_TIKTOK_DOMAIN_LIST: "tiktok.ggdayup.workers.dev"
      DIRECT_MEDIA_DOMAINS: "d.fixtweet.ggdayup.workers.dev"
      TEXT_ONLY_DOMAINS: "t.fixtweet.ggdayup.workers.dev"
      INSTANT_VIEW_DOMAINS: "i.fixtweet.ggdayup.workers.dev"
      GALLERY_DOMAINS: "g.fixtweet.ggdayup.workers.dev"
      FORCE_MOSAIC_DOMAINS: "m.fixtweet.ggdayup.workers.dev"
      MOSAIC_DOMAIN_LIST: "mosaic.fixtweet.ggdayup.workers.dev"
      MOSAIC_BSKY_DOMAIN_LIST: "mosaic.bsky.ggdayup.workers.dev"
      POLYGLOT_DOMAIN_LIST: "polyglot.fixtweet.ggdayup.workers.dev"
      API_HOST_LIST: "api.fixtweet.ggdayup.workers.dev"
      GIF_TRANSCODE_DOMAIN_LIST: "gif.fixtweet.ggdayup.workers.dev"
      OLD_EMBED_DOMAINS: "o.fixtweet.ggdayup.workers.dev"

    steps:
      - name: Checkout target ref
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.git_ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Deploy selected ref
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
          command: deploy --no-bundle

      - name: Summary
        run: |
          echo "âœ… Redeployed ref: ${{ inputs.git_ref }}" >> $GITHUB_STEP_SUMMARY
